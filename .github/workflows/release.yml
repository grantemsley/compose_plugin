# .github/workflows/release.yml
# CI/CD pipeline for Compose Manager plugin
# 
# This workflow automates the release process:
# - Builds TXZ package using Docker (Slackware)
# - Calculates MD5/SHA256 for integrity verification
# - Updates PLG file with correct version and hashes
# - Creates GitHub releases with all artifacts
#
# Triggers:
# - Manual workflow_dispatch for testing builds
# - New tag matching semver pattern (creates release)
#   Pattern: X.Y.Z (e.g., 0.1.4, 1.0.0)

name: Build & Release Plugin

on:
  push:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 0.1.4) - leave empty for test build'
        required: false
        default: ''

permissions:
  contents: write

env:
  PLUGIN_NAME: compose.manager
  COMPOSE_VERSION: '2.40.3'
  COMPOSE_SWITCH_VERSION: '1.0.5'
  ACE_VERSION: '1.4.14'

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
      md5: ${{ steps.hash.outputs.MD5 }}
      sha256: ${{ steps.hash.outputs.SHA256 }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/* ]]; then
            # Release tag - extract version from tag
            VERSION="${GITHUB_REF#refs/tags/}"
          elif [[ -n "${{ github.event.inputs.version }}" ]]; then
            # Manual input
            VERSION="${{ github.event.inputs.version }}"
          else
            # Test build - use git SHA
            VERSION="0.0.0-dev.$(git rev-parse --short HEAD)"
          fi
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "Building version: ${VERSION}"

      - name: Build TXZ package in Docker
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          
          # Set executable permissions
          chmod +x ./build_in_docker.sh
          chmod +x ./source/pkg_build.sh
          
          # Build using the Slackware Docker container
          docker run --rm --tmpfs /tmp \
            -v $PWD/archive:/mnt/output:rw \
            -v $PWD/source:/mnt/source:ro \
            -e TZ="America/New_York" \
            -e COMPOSE_VERSION=${{ env.COMPOSE_VERSION }} \
            -e COMPOSE_SWITCH_VERSION=${{ env.COMPOSE_SWITCH_VERSION }} \
            -e ACE_VERSION=${{ env.ACE_VERSION }} \
            -e OUTPUT_FOLDER="/mnt/output" \
            -e PKG_VERSION="${VERSION}" \
            vbatts/slackware:latest /mnt/source/pkg_build.sh
          
          # Verify package was created
          ls -la ./archive/
          if [[ ! -f "./archive/${{ env.PLUGIN_NAME }}-package-${VERSION}.txz" ]]; then
            echo "ERROR: Package not found!"
            exit 1
          fi

      - name: Calculate hashes
        id: hash
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          PACKAGE="./archive/${{ env.PLUGIN_NAME }}-package-${VERSION}.txz"
          
          MD5=$(md5sum "$PACKAGE" | cut -d' ' -f1)
          SHA256=$(sha256sum "$PACKAGE" | cut -d' ' -f1)
          
          echo "MD5=${MD5}" >> $GITHUB_OUTPUT
          echo "SHA256=${SHA256}" >> $GITHUB_OUTPUT
          
          echo "Package MD5: ${MD5}"
          echo "Package SHA256: ${SHA256}"

      - name: Generate PLG file for release
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          MD5="${{ steps.hash.outputs.MD5 }}"
          
          # Update PLG with correct version and MD5
          sed -i \
            -e "s|<!ENTITY version.*|<!ENTITY version     \"${VERSION}\">|" \
            -e "s|<!ENTITY packageMD5.*|<!ENTITY packageMD5  \"${MD5}\">|" \
            ${{ env.PLUGIN_NAME }}.plg
          
          # Show updated PLG header
          echo "Updated PLG file:"
          head -20 ${{ env.PLUGIN_NAME }}.plg

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: plugin-package
          path: |
            archive/*.txz
            archive/release_info
            ${{ env.PLUGIN_NAME }}.plg
          retention-days: 30

  # Only run release job on tag push
  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: plugin-package
          path: artifacts/

      - name: Prepare release notes
        id: notes
        run: |
          VERSION="${{ needs.build.outputs.VERSION }}"
          
          # Extract release notes from CHANGES section if available
          if [[ -f artifacts/release_info ]]; then
            NOTES=$(cat artifacts/release_info)
          else
            NOTES="Release v${VERSION}"
          fi
          
          # Create release body
          cat > release_body.md << EOF
          ## Compose Manager v${VERSION}
          
          ### Installation
          
          **Via Plugin Manager:**
          \`\`\`
          https://raw.githubusercontent.com/${{ github.repository }}/dev/${{ env.PLUGIN_NAME }}.plg
          \`\`\`
          
          ### Package Details
          - **MD5:** \`${{ needs.build.outputs.md5 }}\`
          - **SHA256:** \`${{ needs.build.outputs.sha256 }}\`
          
          ### Components
          ${NOTES}
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "Compose Manager v${{ needs.build.outputs.version }}"
          body_path: release_body.md
          files: |
            artifacts/archive/*.txz
            artifacts/${{ env.PLUGIN_NAME }}.plg
          fail_on_unmatched_files: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update PLG in repository
        run: |
          VERSION="${{ needs.build.outputs.VERSION }}"
          MD5="${{ needs.build.outputs.md5 }}"
          
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Update PLG file in dev branch
          git checkout dev
          
          # Update version and MD5 in PLG
          sed -i \
            -e "s|<!ENTITY version.*|<!ENTITY version     \"${VERSION}\">|" \
            -e "s|<!ENTITY packageMD5.*|<!ENTITY packageMD5  \"${MD5}\">|" \
            ${{ env.PLUGIN_NAME }}.plg
          
          # Commit and push
          git add ${{ env.PLUGIN_NAME }}.plg
          git commit -m "Update PLG to v${VERSION} [skip ci]" || echo "No changes to commit"
          git push origin dev
