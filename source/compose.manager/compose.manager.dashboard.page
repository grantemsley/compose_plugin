Menu="Dashboard:1"
Cond="is_dir('/usr/local/emhttp/plugins/compose.manager')"
---
<?PHP
/**
 * Compose Manager Dashboard Tile
 * Uses $mytiles pattern with async loading
 * Reuses docker.js context menus and exec.php endpoints from Compose tab
 */

$pluginname = "compose.manager";
$plugin_root = "/usr/local/emhttp/plugins/compose.manager";

if (!is_dir($plugin_root)) return;

$cfg = @parse_ini_file("/boot/config/plugins/compose.manager/compose.manager.cfg");
if (!$cfg) $cfg = [];

$showDashboard = !isset($cfg['SHOW_DASHBOARD_TILE']) || $cfg['SHOW_DASHBOARD_TILE'] !== 'false';
if (!$showDashboard) return;

$hideDockerComposeContainers = isset($cfg['HIDE_DOCKER_COMPOSE_CONTAINERS']) && $cfg['HIDE_DOCKER_COMPOSE_CONTAINERS'] === 'true';

$unraidVersion = @parse_ini_file('/etc/unraid-version')['version'] ?? '0';
$isResponsive = version_compare($unraidVersion, '7.2.0-beta', '>=');

// Translated strings
$tileTitle = _('Compose Stacks');
$tileTitleAttr = _('Go to Compose Manager');
$loadingText = _('Loading...');

// Build tile header
if ($isResponsive) {
    $headerHtml = <<<EOT
<span class='tile-header'>
    <span class='tile-header-left'>
        <i class='fa fa-cubes f32'></i>
        <div class='section'>
            <h3 class='tile-header-main'>$tileTitle</h3>
            <span class='compose-stacks button'>
                <input type='checkbox' id='compose_stacks_toggle'>
            </span>
            <span id='compose_stacks_status' class='compose-stacks switch'></span><br>
        </div>
    </span>
    <span class='tile-header-right'>
        <span class='tile-header-right-controls'>
            <a href='/Docker/Compose' title="$tileTitleAttr">
                <i class='fa fa-fw fa-cog control'></i>
            </a>
        </span>
    </span>
</span>
EOT;
} else {
    $headerHtml = <<<EOT
<i class='fa fa-cubes f32'></i>
<div class='section'>$tileTitle<br>
    <span class='compose-stacks button'>
        <input type='checkbox' id='compose_stacks_toggle'>
    </span>
    <span id='compose_stacks_status' class='compose-stacks switch'></span><br>
</div>
<a href='/Docker/Compose' title="$tileTitleAttr">
    <i class='fa fa-cog control'></i>
</a>
EOT;
}

// Debug setting from config
$debugEnabled = isset($cfg['DEBUG_TO_LOG']) && $cfg['DEBUG_TO_LOG'] === 'true' ? 'true' : 'false';
$hideComposeContainersJs = $hideDockerComposeContainers ? 'true' : 'false';

// CSS and JavaScript
$configScript = <<<EOT
<script>
window.composeDashDebug = $debugEnabled;
window.hideDockerComposeContainers = $hideComposeContainersJs;
</script>
EOT;

$styles = <<<EOT
<style>
#compose_dash_content { padding: 4px 0; }
/* Fixed column widths for perfect alignment */
:root {
    --compose-expand-width: 20px;
    --compose-icon-area: 48px;   /* 32px icon + 16px margins */
    --compose-update-width: 120px;
    --compose-runtime-width: 100px;
}
.compose-dash-stack {
    display: flex;
    align-items: center;
    padding: 8px 8px;
    cursor: pointer;
    border-radius: 4px;
}
.compose-dash-stack:hover { background: rgba(255,255,255,0.05); }
.compose-dash-expand {
    width: var(--compose-expand-width);
    flex-shrink: 0;
    color: #666;
}
.compose-dash-expand::before {
    display: inline-block;
    transition: transform 0.2s;
}
.compose-dash-expand.expanded::before { transform: rotate(90deg); }
.compose-dash-icon {
    width: 32px;
    height: 32px;
    margin: 0 8px;
    flex-shrink: 0;
    border-radius: 4px;
}
.compose-dash-icon img { width: 32px; height: 32px; border-radius: 4px; }
.compose-dash-info { flex: 1; min-width: 80px; }
.compose-dash-name { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.compose-dash-state { font-size: 0.85em; margin-top: 1px; }
.compose-dash-cols { display: flex; align-items: center; gap: 8px; font-size: 0.85em; flex: 2; min-width: 0; overflow: hidden; }
.compose-dash-col { white-space: nowrap; flex-shrink: 0; }
.compose-dash-col.update { width: var(--compose-update-width); }
.compose-dash-col.containers { flex: 1; text-align: center; min-width: 0; }
.compose-dash-col.runtime { width: var(--compose-runtime-width); color: #888; text-align: right; flex-shrink: 0; padding-right: 12px; }
.compose-dash-containers {
    display: none;
    padding: 4px 0 8px 0;
    overflow: hidden;
}
.compose-dash-containers.expanded { display: block; }
.compose-dash-container {
    display: flex;
    align-items: center;
    padding: 6px 8px;
    padding-left: calc(var(--compose-expand-width) + 8px);
    overflow: hidden;
}
.compose-dash-container:hover { background: rgba(255,255,255,0.03); }
/* Container icon: 24px + 24px margins = 48px total to match stack icon area */
.compose-dash-ct-icon { width: 24px; height: 24px; margin: 0 12px; cursor: pointer; flex-shrink: 0; }
.compose-dash-ct-icon img { width: 24px; height: 24px; border-radius: 3px; }
.compose-dash-ct-info { flex: 1; min-width: 80px; overflow: hidden; }
.compose-dash-ct-name { font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.compose-dash-ct-state { font-size: 0.8em; margin-top: 1px; }
.compose-dash-ct-cols { display: flex; align-items: center; gap: 8px; font-size: 0.85em; flex: 2; min-width: 0; overflow: hidden; }
.compose-dash-ct-update { width: var(--compose-update-width); white-space: nowrap; flex-shrink: 0; }
.compose-dash-ct-update .sha { font-family: monospace; font-size: 0.9em; }
.compose-dash-ct-image { width: 0; flex-grow: 1; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.compose-dash-ct-runtime { width: var(--compose-runtime-width); color: #888; text-align: right; white-space: nowrap; flex-shrink: 0; padding-right: 12px; }
.compose-dash-loading { color: #888; font-style: italic; padding: 8px; }
</style>
EOT;

$script = <<<'EOT'
<script>
(function() {
    var caURL = '/plugins/compose.manager/php/exec.php';
    var expandedStacks = {};
    var stackContainerCache = {};

    // Debug logging function - respects plugin debug setting
    function debugLog() {
        if (window.composeDashDebug) {
            console.log.apply(console, ['[ComposeDash]'].concat(Array.prototype.slice.call(arguments)));
        }
    }

    // Resolve WebUI URL placeholders for a container
    // As of this version, WebUI URLs are resolved server-side in exec.php
    // (matching Unraid's DockerClient logic for IP/PORT resolution).
    // This function is kept as a fallback for any unresolved placeholders.
    function resolveContainerWebUI(url) {
        if (!url) return '';
        // Fallback: replace any remaining [IP] with hostname
        url = url.replace(/\[IP\]/gi, window.location.hostname);
        // Fallback: replace any remaining [PORT:xxxx] with the port number
        url = url.replace(/\[PORT:(\d+)\]/gi, '$1');
        return url;
    }

    // Smart uptime formatting - single unit, less granularity over time
    function formatUptime(startedAt, isRunning) {
        if (!isRunning) return 'stopped';
        if (!startedAt) return '';

        var started = new Date(startedAt);
        var now = new Date();
        var diffMs = now - started;
        var mins = Math.floor(diffMs / (1000 * 60));
        var hours = Math.floor(diffMs / (1000 * 60 * 60));
        var days = Math.floor(diffMs / (1000 * 60 * 60 * 24));
        var weeks = Math.floor(days / 7);
        var months = Math.floor(days / 30);
        var years = Math.floor(days / 365);

        if (mins < 120) {
            return mins + ' min' + (mins !== 1 ? 's' : '');
        } else if (hours < 48) {
            return hours + ' hour' + (hours !== 1 ? 's' : '');
        } else if (days < 14) {
            return days + ' day' + (days !== 1 ? 's' : '');
        } else if (weeks < 8) {
            return weeks + ' week' + (weeks !== 1 ? 's' : '');
        } else if (months < 24) {
            return months + ' month' + (months !== 1 ? 's' : '');
        } else {
            return years + ' year' + (years !== 1 ? 's' : '');
        }
    }

    // Stack context menu - called onclick like Docker pattern
    function addStackContext(elementId, stackName, isRunning, webui) {
        debugLog('addStackContext called:', elementId, stackName, isRunning, 'webui:', webui);

        // Check if menu is already open for this element - if so, just close it
        var dropdownId = 'dropdown-' + elementId;
        var $dropdown = $('#' + dropdownId);
        if ($dropdown.length && $dropdown.is(':visible')) {
            debugLog('Menu already open, closing');
            $dropdown.hide();
            return;
        }

        var opts = [];
        context.settings({right:false, above:false});

        if (isRunning) {
            if (webui && webui !== '') {
                opts.push({text:'WebUI', icon:'fa-globe', action:function(e){
                    e.preventDefault();
                    window.open(webui, '_blank');
                }});
            }
            opts.push({text:'Logs', icon:'fa-file-text-o', action:function(e){
                e.preventDefault();
                openStackLogs(stackName);
            }});
            opts.push({divider:true});
            opts.push({text:'Stop', icon:'fa-stop', action:function(e){
                e.preventDefault();
                stackAction(stackName, 'stop');
            }});
            opts.push({text:'Restart', icon:'fa-refresh', action:function(e){
                e.preventDefault();
                stackAction(stackName, 'restart');
            }});
        } else {
            opts.push({text:'Start', icon:'fa-play', action:function(e){
                e.preventDefault();
                stackAction(stackName, 'start');
            }});
        }
        opts.push({divider:true});
        opts.push({text:'Open Compose', icon:'fa-cubes', action:function(e){
            e.preventDefault();
            location.href = '/Docker/Compose';
        }});

        // Destroy and re-attach like Docker pattern
        context.destroy('#' + elementId);
        context.attach('#' + elementId, opts);
        debugLog('Context menu attached to #' + elementId);
    }

    function stackAction(stackName, action) {
        // Map dashboard action names to compose_util.php action names
        var actionMap = {
            'start': 'composeUp',
            'stop': 'composeStop',
            'restart': 'composeUpRecreate'
        };
        var apiAction = actionMap[action] || ('compose' + action.charAt(0).toUpperCase() + action.slice(1));
        var actionTitle = action.charAt(0).toUpperCase() + action.slice(1);
        var $status = $('#compose_stacks_status');
        $status.text(actionTitle + 'ing ' + stackName + '...');

        $.post('/plugins/compose.manager/php/compose_util.php', {
            action: apiAction,
            path: '/boot/config/plugins/compose.manager/projects/' + stackName
        }, function(data) {
            if (data) {
                if (typeof openBox === 'function') {
                    openBox(data, actionTitle + ' Stack ' + stackName, 800, 1200, true);
                } else {
                    Shadowbox.open({content: data, player: 'iframe', title: actionTitle + ' Stack ' + stackName, height: 800, width: 1200});
                }
            }
            // Refresh stacks after a delay to allow command to take effect
            setTimeout(function() { stackContainerCache = {}; loadComposeStacks(); }, 3000);
        });
    }

    function openStackLogs(stackName) {
        // Open combined logs for the stack using the same approach as the Compose page
        var projectPath = '/boot/config/plugins/compose.manager/projects/' + stackName;
        $.post('/plugins/compose.manager/php/compose_util.php', {
            action: 'composeLogs',
            path: projectPath
        }, function(data) {
            if (data && typeof openBox === 'function') {
                openBox(data, 'Stack ' + stackName + ' Logs', 800, 1200, true);
            } else if (data) {
                // Fallback: open in shadowbox or new window
                Shadowbox.open({content: data, player: 'iframe', title: 'Stack ' + stackName + ' Logs', height: 800, width: 1200});
            }
        });
    }

    // Container context menu
    function addContainerContext(elementId, ctName, ctId, isRunning, webui, shell) {
        debugLog('addContainerContext called:', elementId, ctName, isRunning);

        // Check if menu is already open - toggle off
        var dropdownId = 'dropdown-' + elementId;
        var $dropdown = $('#' + dropdownId);
        if ($dropdown.length && $dropdown.is(':visible')) {
            debugLog('Container menu already open, closing');
            $dropdown.hide();
            return;
        }

        var opts = [];
        context.settings({right:false, above:false});

        if (isRunning) {
            if (webui && webui !== '' && webui !== '#') {
                opts.push({text:'WebUI', icon:'fa-globe', action:function(e){
                    e.preventDefault();
                    window.open(webui, '_blank');
                }});
            }
            opts.push({text:'Console', icon:'fa-terminal', action:function(e){
                e.preventDefault();
                openDockerTerminal(ctName, false, shell || '/bin/bash');
            }});
            opts.push({text:'Logs', icon:'fa-file-text-o', action:function(e){
                e.preventDefault();
                openDockerTerminal(ctName, true);
            }});
            opts.push({divider:true});
            opts.push({text:'Stop', icon:'fa-stop', action:function(e){
                e.preventDefault();
                dockerAction(ctName, 'stop');
            }});
            opts.push({text:'Restart', icon:'fa-refresh', action:function(e){
                e.preventDefault();
                dockerAction(ctName, 'restart');
            }});
        } else {
            opts.push({text:'Start', icon:'fa-play', action:function(e){
                e.preventDefault();
                dockerAction(ctName, 'start');
            }});
        }

        context.destroy('#' + elementId);
        context.attach('#' + elementId, opts);
        debugLog('Container context menu attached to #' + elementId);
    }
    window.addContainerContext = addContainerContext;

    function dockerAction(ctName, action) {
        debugLog('dockerAction:', ctName, action);
        $.post(caURL, {
            action: 'containerAction',
            container: ctName,
            containerAction: action
        }, function() {
            // exec.php runs docker commands synchronously, so this fires after completion
            if (!window.hideDockerComposeContainers && typeof window.loadlist === 'function') {
                // Compose containers are visible in Docker tile — loadlist() refreshes it,
                // and our loadlist hook (below) will also trigger loadComposeStacks()
                window.loadlist();
            } else {
                // Compose containers hidden from Docker tile — only refresh our stacks (faster)
                loadComposeStacks();
            }
        });
    }

    // Open terminal - call global openTerminal (from Unraid's HeadInlineJS.php)
    // For logs: openTerminal('docker', containerName, '.log')
    // For console: openTerminal('docker', containerName, shell)
    function openDockerTerminal(name, isLogs, shell) {
        if (typeof window.openTerminal === 'function') {
            window.openTerminal('docker', name, isLogs ? '.log' : (shell || '/bin/bash'));
        } else {
            // Fallback if global function not available
            var url = isLogs
                ? '/logterminal/' + name.replace(/[ #]/g, '_') + '.log/'
                : '/webterminal/docker/';
            window.open(url, '_blank');
        }
    }

    function toggleStack(stackId, stackName) {
        var $containers = $('#compose-dash-ct-' + stackId);
        var $icon = $('#compose-dash-exp-' + stackId);

        if (expandedStacks[stackId]) {
            $containers.removeClass('expanded');
            $icon.removeClass('expanded');
            expandedStacks[stackId] = false;
        } else {
            $containers.addClass('expanded');
            $icon.addClass('expanded');
            expandedStacks[stackId] = true;

            if (!stackContainerCache[stackId]) {
                loadStackContainers(stackId, stackName);
            }
        }
    }

    function loadStackContainers(stackId, stackName) {
        var $container = $('#compose-dash-ct-' + stackId);
        $container.html('<div class="compose-dash-loading"><i class="fa fa-spinner fa-spin"></i> Loading...</div>');

        $.post(caURL, {action: 'getStackContainers', script: stackName}, function(data) {
            try {
                var response = JSON.parse(data);
                if (response.containers && response.containers.length > 0) {
                    var html = '';
                    response.containers.forEach(function(ct) {
                        // API returns capitalized property names: State, ID, Icon, Name, WebUI, Image, UpdateStatus, LocalSha, RemoteSha
                        var isRunning = ct.State === 'running';
                        var stateIcon = isRunning ? 'fa-play' : 'fa-square';
                        var stateColor = isRunning ? 'green-text' : 'red-text';
                        var stateText = isRunning ? 'started' : 'stopped';
                        var ctElId = 'dash-ct-' + ct.ID.substring(0, 12);
                        var imgSrc = ct.Icon || '/plugins/dynamix.docker.manager/images/question.png';
                        var escapedName = ct.Name.replace(/'/g, "\\'");
                        var webui = resolveContainerWebUI(ct.WebUI).replace(/'/g, "\\'");
                        var shell = (ct.Shell || '/bin/bash').replace(/'/g, "\\'");
                        var shortId = ct.ID.substring(0, 12);
                        // Parse image to get repo and tag
                        var image = ct.Image || '';
                        var imageDisplay = image.replace(/^.*\//, ''); // Remove registry prefix

                        // Update status
                        var updateStatus = ct.UpdateStatus || 'unknown';
                        var localSha = ct.LocalSha || '';
                        var remoteSha = ct.RemoteSha || '';
                        var updateHtml = '';
                        if (updateStatus === 'up-to-date') {
                            updateHtml = '<span class="green-text"><i class="fa fa-check"></i> current</span>';
                        } else if (updateStatus === 'update-available' && localSha && remoteSha) {
                            updateHtml = '<span class="orange-text"><span class="sha">' + localSha + '</span> <i class="fa fa-arrow-right"></i> <span class="sha">' + remoteSha + '</span></span>';
                        } else {
                            updateHtml = '<span class="grey-text">--</span>';
                        }

                        // Container uptime - use shared smart formatting
                        var ctUptime = formatUptime(ct.StartedAt, isRunning);

                        html += '<div class="compose-dash-container">';
                        html += '<span class="compose-dash-ct-icon" id="' + ctElId + '" onclick="addContainerContext(\'' + ctElId + '\',\'' + escapedName + '\',\'' + shortId + '\',' + isRunning + ',\'' + webui + '\',\'' + shell + '\')">';
                        html += '<img src="' + imgSrc + '" onerror="this.src=\'/plugins/dynamix.docker.manager/images/question.png\';">';
                        html += '</span>';
                        html += '<span class="compose-dash-ct-info">';
                        html += '<div class="compose-dash-ct-name">' + ct.Name + '</div>';
                        html += '<div class="compose-dash-ct-state ' + stateColor + '"><i class="fa ' + stateIcon + '"></i> ' + stateText + '</div>';
                        html += '</span>';
                        html += '<span class="compose-dash-ct-cols">';
                        html += '<span class="compose-dash-ct-update">' + updateHtml + '</span>';
                        html += '<span class="compose-dash-ct-image" title="' + image + '">' + imageDisplay + '</span>';
                        html += '<span class="compose-dash-ct-runtime">' + ctUptime + '</span>';
                        html += '</span>';
                        html += '</div>';
                    });
                    $container.html(html);

                    stackContainerCache[stackId] = true;
                } else {
                    $container.html('<div class="compose-dash-loading">No containers</div>');
                }
            } catch(e) {
                console.error('Error parsing containers:', e);
                $container.html('<div class="compose-dash-loading">Error loading containers</div>');
            }
        });
    }

    function loadComposeStacks() {
        $.post('/plugins/compose.manager/php/dashboard_stacks.php', function(data) {
            var statusText = 'Stacks -- Started: ' + data.started + ', Stopped: ' + data.stopped;
            if (data.partial > 0) statusText += ', Partial: ' + data.partial;
            $('#compose_stacks_status').text(statusText);

            // Clear container cache since DOM will be rebuilt
            stackContainerCache = {};

            var html = '';
            if (data.stacks.length === 0) {
                html = '<div class="compose-dash-loading">No compose stacks defined</div>';
            } else {
                data.stacks.forEach(function(stack, idx) {
                    // Use folder name for stable IDs (survives DOM rebuilds)
                    var stackId = 'stack-' + stack.folder.replace(/[^a-zA-Z0-9_-]/g, '_');
                    var state = stack.state;
                    var stateIcon = state === 'started' ? 'fa-play' :
                                   (state === 'partial' ? 'fa-exclamation-circle' : 'fa-square');
                    var stateColor = state === 'started' ? 'green-text' :
                                    (state === 'partial' ? 'orange-text' : 'red-text');
                    var stateText = state === 'partial' ? 'partial' : state;
                    var imgSrc = stack.icon || '/plugins/dynamix.docker.manager/images/question.png';
                    var isRunning = state === 'started' || state === 'partial';

                    // Update status display
                    var updateIcon, updateText, updateColor;
                    if (stack.update === 'up-to-date') {
                        updateIcon = 'fa-check'; updateText = 'current'; updateColor = 'green-text';
                    } else if (stack.update === 'update-available') {
                        updateIcon = 'fa-arrow-up'; updateText = 'update'; updateColor = 'orange-text';
                    } else {
                        updateIcon = 'fa-question-circle'; updateText = ''; updateColor = 'grey-text';
                    }

                    // Container count
                    var containerText = stack.running + '/' + stack.total;

                    // Uptime - use smart formatting from startedAt
                    var uptimeText = formatUptime(stack.startedAt, isRunning);

                    // WebUI
                    var webui = (stack.webui || '').replace(/'/g, "\\'");

                    var escapedFolder = stack.folder.replace(/'/g, "\\'");
                    // Add state class for filtering (like Docker tile)
                    var stateClass = state === 'stopped' ? 'stopped' : 'started';
                    html += '<div class="compose-dash-stack outer stacks ' + stateClass + '" data-stackid="' + stackId + '" data-folder="' + escapedFolder + '">';
                    html += '<i class="fa fa-chevron-right compose-dash-expand" id="compose-dash-exp-' + stackId + '"></i>';
                    html += '<span class="compose-dash-icon" id="compose-dash-icon-' + stackId + '" onclick="addStackContext(\'compose-dash-icon-' + stackId + '\',\'' + escapedFolder + '\',' + isRunning + ',\'' + webui + '\')"><img src="' + imgSrc + '" onerror="this.src=\'/plugins/dynamix.docker.manager/images/question.png\';"></span>';
                    html += '<span class="compose-dash-info">';
                    html += '<div class="compose-dash-name">' + $('<div>').text(stack.name).html() + '</div>';
                    html += '<div class="compose-dash-state ' + stateColor + '"><i class="fa ' + stateIcon + '"></i> ' + stateText + '</div>';
                    html += '</span>';
                    html += '<span class="compose-dash-cols">';
                    html += '<span class="compose-dash-col update ' + updateColor + '" title="Update status"><i class="fa ' + updateIcon + '"></i> ' + updateText + '</span>';
                    html += '<span class="compose-dash-col containers" title="Running/Total containers">' + containerText + '</span>';
                    html += '<span class="compose-dash-col runtime" title="Uptime">' + uptimeText + '</span>';
                    html += '</span>';
                    html += '</div>';
                    html += '<div class="compose-dash-containers" id="compose-dash-ct-' + stackId + '"></div>';
                });
            }

            $('#compose_dash_content').html(html);

            // Restore expanded stacks after DOM rebuild
            Object.keys(expandedStacks).forEach(function(stackId) {
                if (expandedStacks[stackId]) {
                    var $containers = $('#compose-dash-ct-' + stackId);
                    var $icon = $('#compose-dash-exp-' + stackId);
                    if ($containers.length) {
                        $containers.addClass('expanded');
                        $icon.addClass('expanded');
                        // Re-fetch container data since DOM was rebuilt
                        // containers div is a sibling after the stack div, not a child
                        var folder = $containers.prev('.compose-dash-stack').data('folder');
                        if (folder) {
                            loadStackContainers(stackId, folder);
                        }
                    } else {
                        // Stack no longer exists, clean up
                        delete expandedStacks[stackId];
                    }
                }
            });

            // Attach row click handlers using event delegation (allows context menu clicks to bubble)
            $('#compose_dash_content').off('click', '.compose-dash-stack').on('click', '.compose-dash-stack', function(e) {
                // Don't toggle if clicking on icon (context menu trigger)
                if ($(e.target).closest('.compose-dash-icon').length) {
                    return;
                }

                // Check if any context menu is currently visible
                var menuOpen = $('.dropdown-context:visible').length > 0;

                // If menu is open and NOT clicking the expand arrow, just let the menu close
                if (menuOpen && !$(e.target).closest('.compose-dash-expand').length) {
                    return;
                }

                var stackId = $(this).data('stackid');
                var folder = $(this).data('folder');
                window.composeToggleStack(stackId, folder);
            });

            // Apply saved filter preference
            var cookie = (typeof $.cookie === 'function' && $.cookie('unraid_settings')) ? JSON.parse($.cookie('unraid_settings')) : {};
            if (cookie.my_stacks === 'startedOnly') {
                $('.compose-dash-stack.stopped').hide();
            }
            noStacks();

            // Hide compose-managed containers from the Docker Containers dashboard tile
            if (window.hideDockerComposeContainers && data.composeContainerNames && data.composeContainerNames.length > 0) {
                setupComposeContainerHiding(data.composeContainerNames);
            }

            debugLog('Loaded', data.stacks.length, 'stacks, context menus attached via onclick');
        }, 'json').fail(function() {
            $('#compose_stacks_status').text('Stacks -- Error loading');
            $('#compose_dash_content').html('<div class="compose-dash-loading red-text">Failed to load stacks</div>');
        });
    }

    // Expose functions globally for onclick handlers
    window.composeToggleStack = toggleStack;
    window.addStackContext = addStackContext;

    // Check if any stacks are visible (for "no stacks" message)
    function noStacks() {
        if ($('#compose_dash_content .compose-dash-stack:visible').length === 0 && $('#compose_dash_content .compose-dash-stack').length > 0) {
            if (!$('#no_stacks').length) {
                $('#compose_dash_content').append('<div id="no_stacks" class="compose-dash-loading">No stacks to display</div>');
            }
            $('#no_stacks').show();
        } else {
            $('#no_stacks').hide();
        }
    }
    window.noStacks = noStacks;

    // Hide compose-managed containers from Unraid's Docker Containers dashboard tile.
    // Docker containers load asynchronously via loadlist() -> $.post('DashboardApps.php')
    // We use $(document).ajaxComplete() to detect when Docker containers are loaded,
    // and a CSS class with !important to prevent jQuery animations from re-showing elements.
    var composeContainerNameSet = null;
    var hideContainersSetup = false;

    function setupComposeContainerHiding(containerNames) {
        if (!containerNames || containerNames.length === 0) return;

        debugLog('Setting up compose container hiding for:', containerNames);
        console.log('[ComposeManager] Container names to hide:', containerNames);

        // Build a lookup object for fast case-insensitive matching
        composeContainerNameSet = {};
        containerNames.forEach(function(n) { composeContainerNameSet[n.toLowerCase()] = true; });

        // Inject CSS class for hiding (uses !important to override jQuery animations like hideMe)
        if (!$('#compose-hide-style').length) {
            $('head').append('<style id="compose-hide-style">.compose-hidden-container { display: none !important; }</style>');
        }

        // Only set up the ajaxComplete handler once
        if (!hideContainersSetup) {
            hideContainersSetup = true;
            // Primary trigger: jQuery ajaxComplete catches DashboardApps.php AJAX loads
            // This fires AFTER the success callback, so DOM is already updated
            $(document).ajaxComplete(function(event, xhr, settings) {
                if (settings && settings.url && settings.url.indexOf('DashboardApps') !== -1) {
                    debugLog('DashboardApps.php AJAX complete, scheduling container hiding');
                    // Small delays to ensure DOM manipulation is fully complete
                    setTimeout(doHideContainers, 50);
                    setTimeout(doHideContainers, 300);
                }
            });
        }

        // Fallback: run several times in case Docker loaded before us
        doHideContainers();
        setTimeout(doHideContainers, 500);
        setTimeout(doHideContainers, 1500);
        setTimeout(doHideContainers, 3000);
        setTimeout(doHideContainers, 5000);
    }

    function doHideContainers() {
        if (!composeContainerNameSet) return;

        var $dockerView = $('#docker_view');
        if (!$dockerView.length) return;

        var hiddenCount = 0;
        // DashboardApps.php renders: <span class="outer solid apps started/stopped/paused">
        $dockerView.find('span.outer.apps').each(function() {
            var $el = $(this);
            // Skip if we already hid this element
            if ($el.hasClass('compose-hidden-container')) return;

            var name = extractContainerName($el);
            if (name && composeContainerNameSet[name.toLowerCase()]) {
                debugLog('Hiding Docker tile container:', name);
                console.log('[ComposeManager] Hiding:', name);
                $el.addClass('compose-hidden-container');
                hiddenCount++;
            }
        });

        if (hiddenCount > 0) {
            debugLog('Hidden', hiddenCount, 'compose containers from Docker tile');
            updateDockerTileCounts();
        }
    }

    function extractContainerName($el) {
        // Strategy 1: Parse onclick="addDockerContainerContext('ContainerName','ImageId',...)"
        // from child <span id="..." class="hand"> element
        // DashboardApps.php: first argument is the container name
        var onclick = '';
        $el.find('[onclick]').each(function() {
            var attr = $(this).attr('onclick') || '';
            if (attr.indexOf('addDockerContainerContext') !== -1) { onclick = attr; return false; }
        });
        if (onclick) {
            var match = onclick.match(/addDockerContainerContext\(\s*'([^']+)'/);
            if (match) return match[1];
        }

        // Strategy 2: Inner span text
        // DashboardApps.php renders: <span class="inner"><span class="...">ContainerName</span>...
        var $inner = $el.find('span.inner > span').first();
        if ($inner.length) {
            var t = $inner.text().trim();
            if (t) return t;
        }

        return null;
    }

    function updateDockerTileCounts() {
        // Recalculate visible Docker container counts excluding hidden compose containers
        var started = $('#docker_view').find('span.outer.apps.started').not('.compose-hidden-container').length;
        var stopped = $('#docker_view').find('span.outer.apps.stopped').not('.compose-hidden-container').length;
        var paused  = $('#docker_view').find('span.outer.apps.paused').not('.compose-hidden-container').length;
        $('.apps.switch').html("Containers -- Started: " + started + ", Stopped: " + stopped + ", Paused: " + paused);
    }

    $(function() {
        // Initialize toggle switch (like Docker's apps toggle)
        var cookie = (typeof $.cookie === 'function' && $.cookie('unraid_settings')) ? JSON.parse($.cookie('unraid_settings')) : {};
        // Initialize header toggle idempotently to avoid duplicate switch rendering
        var $toggle = $('#compose_stacks_toggle');
        if (!$toggle.data('switchbutton-initialized')) {
            $toggle.switchButton({
                labels_placement: 'right',
                off_label: "All Stacks",
                on_label: "Started only",
                checked: cookie.my_stacks === 'startedOnly'
            });
            $toggle.data('switchbutton-initialized', true);
        }
        // Bind change handler once using delegated binding on the container
        $('#compose_dash_content').off('change', '#compose_stacks_toggle').on('change', '#compose_stacks_toggle', function() {
            $('.compose-dash-stack.stopped').finish().toggle('fast', function() { noStacks(); });
            var cookie = (typeof $.cookie === 'function' && $.cookie('unraid_settings')) ? JSON.parse($.cookie('unraid_settings')) : {};
            if ($('#compose_stacks_toggle').is(':checked')) {
                cookie.my_stacks = 'startedOnly';
            } else {
                delete cookie.my_stacks;
            }
            $.cookie('unraid_settings', JSON.stringify(cookie), {expires: 3650, path: '/'});
        });

        loadComposeStacks();
    });

    // ── Cross-widget sync ──────────────────────────────────────────────
    // When the Docker Containers widget refreshes (via loadlist), the
    // Compose Stacks tile on the same dashboard page must also update.
    // We wrap the global loadlist() so that after Docker finishes
    // reloading its container list, we invalidate our container cache
    // and reload stacks.  The wrapper is applied via a retry loop
    // because the Docker widget may define loadlist() after this tile.
    (function hookLoadlist() {
        var composeRefreshTimer = null;

        function wrapLoadlist() {
            if (typeof window.loadlist === 'function' && !window.loadlist._composeDashHooked) {
                var originalLoadlist = window.loadlist;
                window.loadlist = function() {
                    originalLoadlist.apply(this, arguments);
                    // Debounce rapid successive calls (e.g. start-all / stop-all)
                    clearTimeout(composeRefreshTimer);
                    composeRefreshTimer = setTimeout(function() {
                        stackContainerCache = {};
                        loadComposeStacks();
                    }, 2000);
                };
                window.loadlist._composeDashHooked = true;
                debugLog('Hooked loadlist() for dashboard sync');
                return true;
            }
            return false;
        }

        // loadlist may not exist yet — retry every second
        if (!wrapLoadlist()) {
            var hookInterval = setInterval(function() {
                if (wrapLoadlist()) clearInterval(hookInterval);
            }, 1000);
            // Give up after 60 s (dashboard may not have Docker widget)
            setTimeout(function() { clearInterval(hookInterval); }, 60000);
        }
    })();
})();
</script>
EOT;

$mytiles[$pluginname]['column2'] = <<<EOT
<tbody id="compose_stacks_view" title="$tileTitle">
<tr><td>$headerHtml</td></tr>
<tr class='updated'><td><div id='compose_dash_content'><em>$loadingText</em></div></td></tr>
</tbody>
$configScript
$styles
$script
EOT;
?>
