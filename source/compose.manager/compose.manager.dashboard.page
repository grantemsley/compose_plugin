Menu="Dashboard:1"
Cond="is_dir('/usr/local/emhttp/plugins/compose.manager')"
---
<?PHP
/**
 * Compose Manager Dashboard Tile
 * Uses $mytiles pattern with async loading
 * Reuses docker.js context menus and exec.php endpoints from Compose tab
 */

$pluginname = "compose.manager";
$plugin_root = "/usr/local/emhttp/plugins/compose.manager";

if (!is_dir($plugin_root)) return;

$cfg = @parse_ini_file("/boot/config/plugins/compose.manager/compose.manager.cfg");
if (!$cfg) $cfg = [];

$showDashboard = !isset($cfg['SHOW_DASHBOARD_TILE']) || $cfg['SHOW_DASHBOARD_TILE'] !== 'false';
if (!$showDashboard) return;

$unraidVersion = @parse_ini_file('/etc/unraid-version')['version'] ?? '0';
$isResponsive = version_compare($unraidVersion, '7.2.0-beta', '>=');

// Translated strings
$tileTitle = _('Compose Stacks');
$tileTitleAttr = _('Go to Compose Manager');
$loadingText = _('Loading...');

// Build tile header
if ($isResponsive) {
    $headerHtml = <<<EOT
<span class='tile-header'>
    <span class='tile-header-left'>
        <i class='fa fa-cubes f32'></i>
        <div class='section'>
            <h3 class='tile-header-main'>$tileTitle</h3>
            <span class='compose-stacks button'>
                <input type='checkbox' id='compose_stacks_toggle'>
            </span>
            <span id='compose_stacks_status' class='compose-stacks switch'></span><br>
        </div>
    </span>
    <span class='tile-header-right'>
        <span class='tile-header-right-controls'>
            <a href='/Docker/Compose' title="$tileTitleAttr">
                <i class='fa fa-fw fa-cog control'></i>
            </a>
        </span>
    </span>
</span>
EOT;
} else {
    $headerHtml = <<<EOT
<i class='fa fa-cubes f32'></i>
<div class='section'>$tileTitle<br>
    <span class='compose-stacks button'>
        <input type='checkbox' id='compose_stacks_toggle'>
    </span>
    <span id='compose_stacks_status' class='compose-stacks switch'></span><br>
</div>
<a href='/Docker/Compose' title="$tileTitleAttr">
    <i class='fa fa-cog control'></i>
</a>
EOT;
}

// Debug setting from config
$debugEnabled = isset($cfg['DEBUG_TO_LOG']) && $cfg['DEBUG_TO_LOG'] === 'true' ? 'true' : 'false';

// CSS and JavaScript
$configScript = <<<EOT
<script>
window.composeDashDebug = $debugEnabled;
</script>
EOT;

$styles = <<<EOT
<style>
#compose_dash_content { padding: 4px 0; }
.compose-dash-stack { 
    display: flex; 
    align-items: center; 
    padding: 4px 8px;
    cursor: pointer;
    border-radius: 4px;
}
.compose-dash-stack:hover { background: rgba(255,255,255,0.05); }
.compose-dash-expand { 
    width: 20px; 
    transition: transform 0.2s;
    color: #666;
}
.compose-dash-expand.expanded { transform: rotate(90deg); }
.compose-dash-icon { 
    width: 32px; 
    height: 32px; 
    margin: 0 8px;
    border-radius: 4px;
}
.compose-dash-icon img { width: 32px; height: 32px; border-radius: 4px; }
.compose-dash-info { flex: 1; min-width: 0; }
.compose-dash-name { font-weight: 500; }
.compose-dash-state { font-size: 0.85em; margin-top: 1px; }
.compose-dash-cols { display: flex; align-items: center; gap: 12px; font-size: 0.85em; }
.compose-dash-col { white-space: nowrap; }
.compose-dash-col.update { min-width: 70px; }
.compose-dash-col.containers { min-width: 30px; text-align: center; }
.compose-dash-col.uptime { min-width: 60px; color: #888; }
.compose-dash-containers {
    display: none;
    margin-left: 28px;
    padding: 4px 0 8px 0;
    border-left: 2px solid #333;
}
.compose-dash-containers.expanded { display: block; }
.compose-dash-container {
    display: flex;
    align-items: center;
    padding: 3px 8px;
}
.compose-dash-container:hover { background: rgba(255,255,255,0.03); }
.compose-dash-ct-icon { width: 24px; height: 24px; margin-right: 8px; cursor: pointer; }
.compose-dash-ct-icon img { width: 24px; height: 24px; border-radius: 3px; }
.compose-dash-ct-name { flex: 1; font-size: 0.9em; }
.compose-dash-ct-status { font-size: 0.85em; }
.compose-dash-loading { color: #888; font-style: italic; padding: 8px; }
</style>
EOT;

$script = <<<'EOT'
<script>
(function() {
    var caURL = '/plugins/compose.manager/php/exec.php';
    var expandedStacks = {};
    var stackContainerCache = {};
    
    // Debug logging function - respects plugin debug setting
    function debugLog() {
        if (window.composeDashDebug) {
            console.log.apply(console, ['[ComposeDash]'].concat(Array.prototype.slice.call(arguments)));
        }
    }
    
    // Stack context menu - called onclick like Docker pattern
    function addStackContext(elementId, stackName, isRunning, webui) {
        debugLog('addStackContext called:', elementId, stackName, isRunning, 'webui:', webui);
        
        // Check if menu is already open for this element - if so, just close it
        var dropdownId = 'dropdown-' + elementId;
        var $dropdown = $('#' + dropdownId);
        if ($dropdown.length && $dropdown.is(':visible')) {
            debugLog('Menu already open, closing');
            $dropdown.hide();
            return;
        }
        
        var opts = [];
        context.settings({right:false, above:false});
        
        if (isRunning) {
            if (webui && webui !== '') {
                opts.push({text:'WebUI', icon:'fa-globe', action:function(e){
                    e.preventDefault();
                    window.open(webui, '_blank');
                }});
            }
            opts.push({text:'Logs', icon:'fa-file-text-o', action:function(e){
                e.preventDefault();
                openStackLogs(stackName);
            }});
            opts.push({divider:true});
            opts.push({text:'Stop', icon:'fa-stop', action:function(e){
                e.preventDefault();
                stackAction(stackName, 'stop');
            }});
            opts.push({text:'Restart', icon:'fa-refresh', action:function(e){
                e.preventDefault();
                stackAction(stackName, 'restart');
            }});
        } else {
            opts.push({text:'Start', icon:'fa-play', action:function(e){
                e.preventDefault();
                stackAction(stackName, 'start');
            }});
        }
        opts.push({divider:true});
        opts.push({text:'Open Compose', icon:'fa-cubes', action:function(e){
            e.preventDefault();
            location.href = '/Docker/Compose';
        }});
        
        // Destroy and re-attach like Docker pattern
        context.destroy('#' + elementId);
        context.attach('#' + elementId, opts);
        debugLog('Context menu attached to #' + elementId);
    }
    
    function stackAction(stackName, action) {
        var $status = $('#compose_stacks_status');
        $status.text(action.charAt(0).toUpperCase() + action.slice(1) + 'ing ' + stackName + '...');
        
        $.post('/plugins/compose.manager/php/compose_util.php', {
            action: 'compose' + action.charAt(0).toUpperCase() + action.slice(1),
            path: '/boot/config/plugins/compose.manager/projects/' + stackName
        }, function() {
            setTimeout(loadComposeStacks, 1000);
        });
    }
    
    function openStackLogs(stackName) {
        // Open combined logs for the stack using the same approach as the Compose page
        var projectPath = '/boot/config/plugins/compose.manager/projects/' + stackName;
        $.post('/plugins/compose.manager/php/compose_util.php', {
            action: 'composeLogs',
            path: projectPath
        }, function(data) {
            if (data && typeof openBox === 'function') {
                openBox(data, 'Stack ' + stackName + ' Logs', 800, 1200, true);
            } else if (data) {
                // Fallback: open in shadowbox or new window
                Shadowbox.open({content: data, player: 'iframe', title: 'Stack ' + stackName + ' Logs', height: 800, width: 1200});
            }
        });
    }
    
    // Container context menu
    function addContainerContext(elementId, ctName, ctId, isRunning, webui, shell) {
        debugLog('addContainerContext called:', elementId, ctName, isRunning);
        
        // Check if menu is already open - toggle off
        var dropdownId = 'dropdown-' + elementId;
        var $dropdown = $('#' + dropdownId);
        if ($dropdown.length && $dropdown.is(':visible')) {
            debugLog('Container menu already open, closing');
            $dropdown.hide();
            return;
        }
        
        var opts = [];
        context.settings({right:false, above:false});
        
        if (isRunning) {
            if (webui && webui !== '' && webui !== '#') {
                opts.push({text:'WebUI', icon:'fa-globe', action:function(e){
                    e.preventDefault();
                    window.open(webui, '_blank');
                }});
            }
            opts.push({text:'Console', icon:'fa-terminal', action:function(e){
                e.preventDefault();
                openDockerTerminal(ctName, false, shell || 'sh');
            }});
            opts.push({text:'Logs', icon:'fa-file-text-o', action:function(e){
                e.preventDefault();
                openDockerTerminal(ctName, true);
            }});
            opts.push({divider:true});
            opts.push({text:'Stop', icon:'fa-stop', action:function(e){
                e.preventDefault();
                dockerAction(ctId, 'stop');
            }});
            opts.push({text:'Restart', icon:'fa-refresh', action:function(e){
                e.preventDefault();
                dockerAction(ctId, 'restart');
            }});
        } else {
            opts.push({text:'Start', icon:'fa-play', action:function(e){
                e.preventDefault();
                dockerAction(ctId, 'start');
            }});
        }
        
        context.destroy('#' + elementId);
        context.attach('#' + elementId, opts);
        debugLog('Container context menu attached to #' + elementId);
    }
    window.addContainerContext = addContainerContext;
    
    function dockerAction(ctId, action) {
        debugLog('dockerAction:', ctId, action);
        $.post('/plugins/dynamix.docker.manager/include/Events.php', {
            action: 'docker_' + action,
            container: ctId
        }, function() {
            // Refresh after a short delay
            setTimeout(loadComposeStacks, 1500);
        });
    }
    
    // Open terminal - call global openTerminal (from Unraid's HeadInlineJS.php)
    // For logs: openTerminal('docker', containerName, '.log')
    // For console: openTerminal('docker', containerName, shell)
    function openDockerTerminal(name, isLogs, shell) {
        if (typeof window.openTerminal === 'function') {
            window.openTerminal('docker', name, isLogs ? '.log' : (shell || 'sh'));
        } else {
            // Fallback if global function not available
            var url = isLogs
                ? '/logterminal/' + name.replace(/[ #]/g, '_') + '.log/'
                : '/webterminal/docker/';
            window.open(url, '_blank');
        }
    }
    
    function toggleStack(stackId, stackName) {
        var $containers = $('#compose-dash-ct-' + stackId);
        var $icon = $('#compose-dash-exp-' + stackId);
        
        if (expandedStacks[stackId]) {
            $containers.removeClass('expanded');
            $icon.removeClass('expanded');
            expandedStacks[stackId] = false;
        } else {
            $containers.addClass('expanded');
            $icon.addClass('expanded');
            expandedStacks[stackId] = true;
            
            if (!stackContainerCache[stackId]) {
                loadStackContainers(stackId, stackName);
            }
        }
    }
    
    function loadStackContainers(stackId, stackName) {
        var $container = $('#compose-dash-ct-' + stackId);
        $container.html('<div class="compose-dash-loading"><i class="fa fa-spinner fa-spin"></i> Loading...</div>');
        
        $.post(caURL, {action: 'getStackContainers', script: stackName}, function(data) {
            try {
                var response = JSON.parse(data);
                if (response.containers && response.containers.length > 0) {
                    var html = '';
                    response.containers.forEach(function(ct) {
                        // API returns capitalized property names: State, ID, Icon, Name, WebUI
                        var isRunning = ct.State === 'running';
                        var stateIcon = isRunning ? 'fa-play green-text' : 'fa-square red-text';
                        var ctElId = 'dash-ct-' + ct.ID.substring(0, 12);
                        var imgSrc = ct.Icon || '/plugins/dynamix.docker.manager/images/question.png';
                        var escapedName = ct.Name.replace(/'/g, "\\'");
                        var webui = (ct.WebUI || '').replace(/'/g, "\\'");
                        var shell = (ct.Shell || 'sh').replace(/'/g, "\\'");
                        var shortId = ct.ID.substring(0, 12);
                        
                        html += '<div class="compose-dash-container">';
                        html += '<span class="compose-dash-ct-icon" id="' + ctElId + '" onclick="addContainerContext(\'' + ctElId + '\',\'' + escapedName + '\',\'' + shortId + '\',' + isRunning + ',\'' + webui + '\',\'' + shell + '\')">';
                        html += '<img src="' + imgSrc + '" onerror="this.src=\'/plugins/dynamix.docker.manager/images/question.png\';">';
                        html += '</span>';
                        html += '<span class="compose-dash-ct-name">' + ct.Name + '</span>';
                        html += '<span class="compose-dash-ct-status"><i class="fa ' + stateIcon + '"></i></span>';
                        html += '</div>';
                    });
                    $container.html(html);
                    
                    stackContainerCache[stackId] = true;
                } else {
                    $container.html('<div class="compose-dash-loading">No containers</div>');
                }
            } catch(e) {
                console.error('Error parsing containers:', e);
                $container.html('<div class="compose-dash-loading">Error loading containers</div>');
            }
        });
    }
    
    function loadComposeStacks() {
        $.post('/plugins/compose.manager/php/dashboard_stacks.php', function(data) {
            var statusText = 'Stacks -- Started: ' + data.started + ', Stopped: ' + data.stopped;
            if (data.partial > 0) statusText += ', Partial: ' + data.partial;
            $('#compose_stacks_status').text(statusText);
            
            var html = '';
            if (data.stacks.length === 0) {
                html = '<div class="compose-dash-loading">No compose stacks defined</div>';
            } else {
                data.stacks.forEach(function(stack, idx) {
                    var stackId = 'stack-' + idx;
                    var state = stack.state;
                    var stateIcon = state === 'started' ? 'fa-play' : 
                                   (state === 'partial' ? 'fa-exclamation-circle' : 'fa-square');
                    var stateColor = state === 'started' ? 'green-text' : 
                                    (state === 'partial' ? 'orange-text' : 'red-text');
                    var stateText = state === 'partial' ? 'partial' : state;
                    var imgSrc = stack.icon || '/plugins/dynamix.docker.manager/images/question.png';
                    var isRunning = state === 'started' || state === 'partial';
                    
                    // Update status display
                    var updateIcon, updateText, updateColor;
                    if (stack.update === 'up-to-date') {
                        updateIcon = 'fa-check'; updateText = 'current'; updateColor = 'green-text';
                    } else if (stack.update === 'update-available') {
                        updateIcon = 'fa-arrow-up'; updateText = 'update'; updateColor = 'orange-text';
                    } else {
                        updateIcon = 'fa-question-circle'; updateText = ''; updateColor = 'grey-text';
                    }
                    
                    // Container count
                    var containerText = stack.running + '/' + stack.total;
                    
                    // Uptime
                    var uptimeText = stack.uptime || (state === 'stopped' ? 'stopped' : '');
                    
                    // WebUI
                    var webui = (stack.webui || '').replace(/'/g, "\\'");
                    
                    var escapedFolder = stack.folder.replace(/'/g, "\\'");
                    // Add state class for filtering (like Docker tile)
                    var stateClass = state === 'stopped' ? 'stopped' : 'started';
                    html += '<div class="compose-dash-stack outer stacks ' + stateClass + '" data-stackid="' + stackId + '" data-folder="' + escapedFolder + '">';
                    html += '<i class="fa fa-chevron-right compose-dash-expand" id="compose-dash-exp-' + stackId + '"></i>';
                    html += '<span class="compose-dash-icon" id="compose-dash-icon-' + stackId + '" onclick="addStackContext(\'compose-dash-icon-' + stackId + '\',\'' + escapedFolder + '\',' + isRunning + ',\'' + webui + '\')"><img src="' + imgSrc + '" onerror="this.src=\'/plugins/dynamix.docker.manager/images/question.png\';"></span>';
                    html += '<span class="compose-dash-info">';
                    html += '<div class="compose-dash-name">' + $('<div>').text(stack.name).html() + '</div>';
                    html += '<div class="compose-dash-state ' + stateColor + '"><i class="fa ' + stateIcon + '"></i> ' + stateText + '</div>';
                    html += '</span>';
                    html += '<span class="compose-dash-cols">';
                    html += '<span class="compose-dash-col update ' + updateColor + '" title="Update status"><i class="fa ' + updateIcon + '"></i> ' + updateText + '</span>';
                    html += '<span class="compose-dash-col containers" title="Running/Total containers">' + containerText + '</span>';
                    html += '<span class="compose-dash-col uptime" title="Uptime">' + uptimeText + '</span>';
                    html += '</span>';
                    html += '</div>';
                    html += '<div class="compose-dash-containers" id="compose-dash-ct-' + stackId + '"></div>';
                });
            }
            
            $('#compose_dash_content').html(html);
            
            // Attach row click handlers using event delegation (allows context menu clicks to bubble)
            $('#compose_dash_content').off('click', '.compose-dash-stack').on('click', '.compose-dash-stack', function(e) {
                // Don't toggle if clicking on icon (context menu trigger)
                if ($(e.target).closest('.compose-dash-icon').length) {
                    return;
                }
                
                // Check if any context menu is currently visible
                var menuOpen = $('.dropdown-context:visible').length > 0;
                
                // If menu is open and NOT clicking the expand arrow, just let the menu close
                if (menuOpen && !$(e.target).closest('.compose-dash-expand').length) {
                    return;
                }
                
                var stackId = $(this).data('stackid');
                var folder = $(this).data('folder');
                window.composeToggleStack(stackId, folder);
            });
            
            // Apply saved filter preference
            var cookie = (typeof $.cookie === 'function' && $.cookie('unraid_settings')) ? JSON.parse($.cookie('unraid_settings')) : {};
            if (cookie.my_stacks === 'startedOnly') {
                $('.compose-dash-stack.stopped').hide();
            }
            noStacks();
            
            debugLog('Loaded', data.stacks.length, 'stacks, context menus attached via onclick');
        }, 'json').fail(function() {
            $('#compose_stacks_status').text('Stacks -- Error loading');
            $('#compose_dash_content').html('<div class="compose-dash-loading red-text">Failed to load stacks</div>');
        });
    }
    
    // Expose functions globally for onclick handlers
    window.composeToggleStack = toggleStack;
    window.addStackContext = addStackContext;
    
    // Check if any stacks are visible (for "no stacks" message)
    function noStacks() {
        if ($('#compose_dash_content .compose-dash-stack:visible').length === 0 && $('#compose_dash_content .compose-dash-stack').length > 0) {
            if (!$('#no_stacks').length) {
                $('#compose_dash_content').append('<div id="no_stacks" class="compose-dash-loading">No stacks to display</div>');
            }
            $('#no_stacks').show();
        } else {
            $('#no_stacks').hide();
        }
    }
    window.noStacks = noStacks;
    
    $(function() {
        // Initialize toggle switch (like Docker's apps toggle)
        var cookie = (typeof $.cookie === 'function' && $.cookie('unraid_settings')) ? JSON.parse($.cookie('unraid_settings')) : {};
        $('#compose_stacks_toggle').switchButton({
            labels_placement: 'right',
            off_label: "All Stacks",
            on_label: "Started only",
            checked: cookie.my_stacks === 'startedOnly'
        });
        $('#compose_stacks_toggle').change(function() {
            $('.compose-dash-stack.stopped').finish().toggle('fast', function() { noStacks(); });
            var cookie = (typeof $.cookie === 'function' && $.cookie('unraid_settings')) ? JSON.parse($.cookie('unraid_settings')) : {};
            if ($('#compose_stacks_toggle').is(':checked')) {
                cookie.my_stacks = 'startedOnly';
            } else {
                delete cookie.my_stacks;
            }
            $.cookie('unraid_settings', JSON.stringify(cookie), {expires: 3650, path: '/'});
        });
        
        loadComposeStacks();
    });
})();
</script>
EOT;

$mytiles[$pluginname]['column2'] = <<<EOT
<tbody id="compose_stacks_view" title="$tileTitle">
<tr><td>$headerHtml</td></tr>
<tr class='updated'><td><div id='compose_dash_content'><em>$loadingText</em></div></td></tr>
</tbody>
$configScript
$styles
$script
EOT;
?>
