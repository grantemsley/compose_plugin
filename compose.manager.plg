<?xml version='1.0' standalone='yes'?>
<!DOCTYPE PLUGIN [
<!ENTITY name        "compose.manager">
<!ENTITY author      "mstrhakr">
<!ENTITY version     "2026.02.08">
<!ENTITY launch      "Settings/&name;">
<!ENTITY packageVER  "&version;">
<!ENTITY packageMD5  "20690dd3cf2dd0d22f1f3f16918ccd54">
<!ENTITY packageName "&name;-package-&packageVER;">
<!ENTITY packagefile "&packageName;.txz">
<!ENTITY github      "mstrhakr/compose_plugin">
<!ENTITY pluginURL   "https://raw.githubusercontent.com/&github;/main/&name;.plg">
<!ENTITY packageURL  "https://github.com/&github;/releases/download/v&version;/&packagefile;">
<!ENTITY pluginLOC   "/boot/config/plugins/&name;">
<!ENTITY emhttpLOC   "/usr/local/emhttp/plugins/&name;">
]>

<PLUGIN  name="&name;"
         author="&author;"
         version="&version;"
         launch="&launch;"
         pluginURL="&pluginURL;"
         icon="cubes"
         min="6.9.0"
         support="https://github.com/mstrhakr/compose_plugin/issues"
         project="https://github.com/mstrhakr/compose_plugin"
         readme="https://github.com/mstrhakr/compose_plugin#readme"
>

<CHANGES>
###2026.02.08
- Features: enable blank issues and add feature request template for contributions
- Features: add issues section to issue template configuration
- Features: add issue and pull request templates for better contribution guidelines
- Features: create initial override file for UI labels if it doesn't exist and remove old modal for editing the override file
- Bug Fixes: enhance UI feedback with localized spinners and status icons for compose actions
- Bug Fixes: include --all flag in docker compose commands to return exited/stopped containers
- Bug Fixes: improve switch button initialization and ensure consistent label alignment
- Bug Fixes: enhance switchButton initialization to prevent re-binding and ensure consistent state
- Bug Fixes: replace outdated bug report template with a new structured format
- Bug Fixes: remove outdated bug report template from issue configuration
- Bug Fixes: correct name field in bug report template
- Bug Fixes: standardize quotes and formatting in bug report template
- Bug Fixes: add quotes around bug report name
- Bug Fixes: remove title field from bug report template
- Bug Fixes: correct placeholder syntax in bug report template title
- Bug Fixes: update support forum URL in issue template configuration
- Bug Fixes: ensure text coverage report is generated in phpunit configuration
- Bug Fixes: add workspace instructions file to .gitignore
- Chores: remove outdated bug report and feature request templates
- Update issue templates by adding bug report template from webui
- [View all changes](https://github.com/mstrhakr/compose_plugin/compare/v2026.02.03d...v2026.02.08)
###2026.02.03d
- Features: implement stack recheck functionality with server-side persistence
- [View all changes](https://github.com/mstrhakr/compose_plugin/compare/v2026.02.03c...v2026.02.03d)
###2026.02.03c
- Features: add functionality to recreate containers after label changes
- Bug Fixes: enhance output formatting for stack command execution
- Bug Fixes: improve user experience by ensuring modal closes before executing commands
- Bug Fixes: update commit message to reflect release tagging
- [View all changes](https://github.com/mstrhakr/compose_plugin/compare/v2026.02.03b...v2026.02.03c)
###2026.02.03b
- Bug Fixes: Update tests to not depend on shell rm command
- Refactoring: split functions into separate files for testability
  - Extract functions from exec.php to exec_functions.php
  - Extract functions from compose_list.php to compose_list_functions.php
  - Extract functions from compose_util.php to compose_util_functions.php
  - Update tests to use real source files instead of reimplementing logic
  - Rewrite ExecActionsTest to test actual exec.php switch statements
- Tests: Migrate to plugin-tests framework with PluginBootstrap
  - Use PluginBootstrap for automatic path mapping and globals setup
  - Remove custom mock files (compose_util_functions.php, exec_functions.php)
  - Add DefinesTest for LOCATE_COMPOSE_ROOT function
  - Update all test files to use framework's TestCase
  - Add local bootstrap.php and UnraidStreamWrapper.php wrappers
  - Update phpunit.xml for new bootstrap
  - 91 tests passing with 15.79% coverage
- Chores: Remove .github/compose_plugin.code-workspace and update .gitignore
- Chores: Update plugin-tests submodule to v0.2 floating tag
- Add comprehensive unit tests for compose plugin
  - IconTest: Tests icon file discovery, MIME type detection, sanitization
  - ExecActionsTest: Tests simple exec.php actions (changeName, changeDesc, etc.)
  - ExecStackManagementTest: Tests stack creation/deletion and file operations
  - ComposeListTest: Tests stack list generation helpers
  - DashboardStacksTest: Tests dashboard tile data generation
- [View all changes](https://github.com/mstrhakr/compose_plugin/compare/v2026.02.03a...v2026.02.03b)
###2026.02.03a
- Features: Add Docker update tests and update plugin-tests to v0.1.1
- Features: add comprehensive test infrastructure
  - Add plugin-tests as submodule with PHP/BATS mocks
  - Add PHPUnit 10 for PHP unit testing
  - Add PHPStan 2.1 for static analysis
  - Add Xdebug code coverage support
  - tests/unit/UtilTest.php - 12 tests for util.php functions
  - tests/unit/compose.bats - 17 BATS tests for shell scripts
  - Add GitHub Actions workflow for automated testing
  - JUnit XML output for test reporting
  - Coverage reports in Clover format
  - phpunit.xml with coverage reporting
  - phpstan.neon ignoring platform-specific functions
  - composer.json with dev dependencies
  - .gitignore for vendor/, coverage/, cache/
  - docs/testing.md with usage guide
- Features: add operation locking to prevent concurrent stack operations
  - Two users clicking Start simultaneously
  - Auto-update running while manual update in progress
  - Rapid button clicks before previous operation completes
  - Add file-based locking using flock()
  - Lock acquired before state-changing operations (up/down/pull/update/stop)
  - Lock released automatically via trap on EXIT
  - 30 second timeout waiting for existing lock (COMPOSE_LOCK_TIMEOUT)
  - Clear user feedback when waiting for lock
  - Read-only operations (list/ps/logs) don't require lock
  - acquireStackLock() - acquire lock with timeout
  - releaseStackLock() - release lock
  - isStackLocked() - check if stack is locked (for UI)
  - getStackLastResult() - get last operation result
  - checkStackLock action - API to check lock status
  - getStackResult action - API to get last operation result
- Features (autostart): sequential startup with Docker wait option
  - Start compose stacks sequentially (one at a time)
  - Prevents interference between stacks during startup
  - More predictable and debuggable
  - Respects startup_priority for ordering (lower = earlier)
  - Add 'Wait for Docker Autostart' option (AUTOSTART_WAIT_FOR_DOCKER)
  - When enabled, waits for Docker's autostart containers to stabilize
  - Useful when compose stacks depend on non-compose containers or you have limited system resources
  - Monitors for containers with status=created or health=starting
  - Requires 2 consecutive stable checks before proceeding
  - Add Docker Wait Timeout setting (AUTOSTART_DOCKER_WAIT_TIMEOUT)
  - Default 120 seconds, configurable 30-600s
  - Proceeds with compose startup after timeout (with warning)
  - Add Stack Startup Timeout setting (AUTOSTART_TIMEOUT)
  - Default 300 seconds (5 min), configurable 60-900s
  - Prevents hung stacks from blocking subsequent stacks
  - Improved logging with progress indicators
  - Shows [1/N] progress for each stack
  - Summary at end: succeeded/failed/timed out
  - Added new toggle: Wait for Docker Autostart
  - Added new inputs: Docker Wait Timeout, Stack Startup Timeout
  - Added helpful descriptions for each setting
- Features (compose.sh): add retry logic, error handling, and result tracking
  - Add run_with_retry() function for transient failure handling
  - Retries up to 3 times (configurable via COMPOSE_MAX_RETRIES)
  - Detects network errors, timeouts, connection refused
  - 5 second delay between retries (configurable via COMPOSE_RETRY_DELAY)
  - Add proper error handling for all commands (up, down, pull, update, stop)
  - Check exit codes after each docker compose command
  - Log errors to syslog via logger -t compose.manager
  - Show clear success/failure messages in output
  - Add save_result() to persist operation status
  - Writes last_result.json to stack directory
  - Includes result, exit_code, operation, and timestamp
  - Enables frontend to check operation outcomes
  - Improve update command reliability
  - Abort update if pull fails (don't recreate with old images)
  - Add progress messages for each phase
  - Suppress non-fatal errors in image cleanup
  - Replace raw logger calls with log_msg() helper
  - Consistent format: [LEVEL] message
  - Tagged as compose.manager for easy filtering
- Features (shutdown): improve shutdown handler with timeout and logging
  - Add timeout protection (SHUTDOWN_TIMEOUT, default 60s)
  - Prevents hung stacks from blocking system shutdown
  - Falls back to 'docker compose kill' if graceful stop times out
  - Add comprehensive logging
  - Logs to /var/log/compose.manager.log and syslog
  - Shows start/stop status and duration for each stack
  - Clear markers for shutdown begin/complete
  - Stop ALL stacks, not just autostart ones
  - Previously only stopped stacks with autostart flag
  - Now properly stops any running compose stack
  - Keep parallel stop for faster shutdown
  - Unlike startup, shutdown benefits from parallelism
  - System shutdown shouldn't wait for sequential stops
  - Direct docker compose calls (skip wrapper for speed)
  - Shutdown needs to be fast and simple
  - Avoids retry logic that could delay shutdown
- Features (stack): enhance stack creation popup with optional description and improved response
- Bug Fixes: Use temp directory for DockerUtil JSON tests
- Bug Fixes: Update PHPStan config to ignore platform-specific code
  - Lower level to 5 (more practical for legacy Unraid code)
  - Ignore undefined global variables from defines.php
  - Ignore missing platform classes (DockerClient, DockerUpdate, DockerUtil)
  - Ignore untyped parameters/returns in legacy functions
  - Ignore strict comparison warnings in existing code
  - Fix PHPDoc @var tag in util.php
- Bug Fixes: Make lock directory configurable for testing
  - Add getLockDir() function that checks \['compose_lock_dir']
  - Falls back to /var/run/compose.manager if not set
  - Tests now use sys_get_temp_dir() for lock tests
  - Fixes CI failures on GitHub Actions where /var/run is not writable
- Bug Fixes (docs): move documentation for Docker Compose profiles support to cleanup main README
- Bug Fixes (styles): adjust modal overlay z-index and alignment for improved display
- Bug Fixes (workspace): add workspace configuration for testing and update BATS settings
- Tests: Add ComposeUtilTest and expand edge case coverage
  - ComposeUtilTest.php: Tests for compose command building
  - buildComposeCommandArgs() tests for profiles, override, env paths, indirect
  - sanitizeStackName() tests for special character handling
  - formatComposeCommandForOutput() tests
  - Data provider tests for various compose actions
  - compose_util_functions.php: Extracted testable functions from compose_util.php
  - buildComposeCommandArgs() - Builds compose command argument array
  - formatComposeCommandForOutput() - Formats args for URL params
  - sanitizeStackName() - Sanitizes input for safe folder names
  - ExecFunctionsTest.php: Added edge case tests
  - lscr.io registry (Linuxserver new format)
  - Registry with port (registry.local:5000)
  - Deeply nested paths (gcr.io/google-containers/...)
  - sha256 in tag name vs digest
  - Empty string handling
  - Uppercase handling
  - getElement edge cases
- Tests: Add comprehensive unit tests for exec.php and util.php functions
  - Add ExecFunctionsTest.php with 15 tests for getElement() and normalizeImageForUpdateCheck()
  - Add exec_functions.php with extracted testable functions and DockerUtil mock
  - Expand UtilTest.php from 12 to 21 tests with:
  - Stack locking tests (acquireStackLock, releaseStackLock, isStackLocked)
  - Edge cases for sanitizeStr (empty string, underscores, numbers, multiple special chars)
- Chores: Update plugin-tests submodule to v0.1.2
  - DockerUtil: Accurate parseImageTag(), splitImage(), ensureImageTag()
  - New helper function mocks: _var, my_scale, compress, etc.
  - DockerTemplates mock class
- Chores: Update plugin-tests submodule to v0.1.0
  - VS Code extension with BATS/PHPUnit test runner
  - Improved PHP mocks with global namespace functions
  - Fixed duplicate mock logging
  - CI/CD with release workflow
- [View all changes](https://github.com/mstrhakr/compose_plugin/compare/v2026.02.03...v2026.02.03a)
###2026.02.03
- Features (dashboard): enhance uptime display with smart formatting and adjust column widths
- Features (settings): enhance settings page with toggle switches and improved styling
- Styles (tabs): improve tab styling with enhanced opacity and transition effects
- Dashboard tile: add container details, stack runtime tracking, and smart uptime formatting
  - Add expandable container rows showing: name/status, update status with SHA, image tag, runtime
  - Add All Stacks/Started only toggle matching Docker tile style
  - Save stack started_at timestamp on up/update commands for accurate runtime
  - Smart uptime formatting: minsΓåÆhoursΓåÆdaysΓåÆweeksΓåÆmonthsΓåÆyears based on duration
  - Rename uptime classes to runtime to avoid Unraid dashboard JS interference
  - Wider column widths for better readability
  - Both dashboard tile and Compose tab now use consistent runtime display
- [View all changes](https://github.com/mstrhakr/compose_plugin/compare/v2026.02.02d...v2026.02.03)
###2026.02.02d
- Features (ui): enhance dashboard with additional columns for dockers in compose stack
- Features (ui): add toggle for displaying only started stacks in Compose Manager dashboard tile
- Features (ui): fix advanced view toggle for standalone and joined tabs
  - Add fallback for standalone xmenu pages where .tabs element doesn't exist
  - Create standalone toggle container above the stacks table when no tabs present
  - Apply view mode to dynamically inserted update column elements
  - Ensures force update link only shows in advanced view as expected
- Bug Fixes (logs): correct terminal URLs for container logs and stack logs
  - Fix container logs in compose_manager_main.php: use openTerminal('docker_logs', containerName) instead of incorrect ('docker', containerName, '.log')
  - Fix stack logs on dashboard: use AJAX call to compose_util.php instead of non-existent /Docker/ComposeLog page
  - Fix dashboard container logs: use openDockerTerminal wrapper that properly calls global openTerminal('docker', name, '.log') for logs
- [View all changes](https://github.com/mstrhakr/compose_plugin/compare/v2026.02.02c...v2026.02.02d)
###2026.02.02c
- Features (release): Add category grouping with type and scope parsing
  - Group commits by conventional commit type (feat, fix, docs, etc.)
  - Show scope in parentheses when present
  - Major commits (with body) show bullet points
  - Uncategorized commits listed after categorized ones
- Features (release): Add categorized changelog generation from conventional commits
  - Parse conventional commit format (type(scope): message)
  - Categorize commits by type (feat, fix, docs, refactor, etc.)
  - Display scope in bold when present
  - Filter out release and changelog commits
- Move documentation images to docs/images folder
  - Move screenshots from source/compose.manager/images/ to docs/images/
  - Update all image references in README and docs
  - Remove unused compose-manager-ui.png
- [View all changes](https://github.com/mstrhakr/compose_plugin/compare/v2026.02.02b...v2026.02.02c)
###2026.02.01j
- Scope UI initialization and updates to avoid conflicts with Docker tab
###2026.02.01i
- Rename loadlist function to composeLoadlist for namespace clarity
###2026.02.01h
- Update UI for auto check interval and add settings button in stack actions
- Enhance stack creation by returning project details for frontend integration
###2026.02.01g
- Add support for default and multiple profiles in stack operations
###2026.02.01f
- Fix update checking for images pinned with SHA256 digest
- Images pinned to specific digests now show 'pinned' status instead of 'not checked'
###2026.02.01e
- Add functions to start and stop all stacks
- Handle multiple stack commands
###2026.02.01
- Revamp CI/CD workflows for improved release automation and versioning
- Add clear update cache functionality to manage stale entries
###0.1.3
- Refactor async timers to avoid collision
- Add missing ace mode-sh.js file
- Add asynchronous stack list loader for improved page load performance
- Implement auto-check for updates feature with configurable interval
###0.1.2
- Add project URL and readme link to plugin metadata
- Add detailed package description
###0.1.1
- Enhance release script to support version bumping and rollback on failure
- Enhance plugin description and usage instructions in metadata
- Add build and release scripts
###0.1.0
- Fork from dcflachs/compose_plugin
- Add expandable stack rows with container details table
- Add container icons fetched from Docker templates
- Add context menus for stacks and containers (right-click)
- Add Check for Updates button with SHA digest comparison
- Add update status column matching Docker tab style
- Add confirmation dialogs for stack actions (up/down/update)
- Add Advanced View toggle with force update option
- Replace autostart column with update status column
- Use native Unraid SweetAlert for all dialogs
- Add tabbed editor modal for compose files (docker-compose.yml, .env, override)
- Add real-time YAML syntax validation using js-yaml
- Track unsaved changes with visual indicators on tabs
- Keyboard shortcuts: Ctrl+S to save, Escape to close
- Fix XSS vulnerability in YAML error display
- Add ARIA accessibility attributes to editor modal
- Replace swal2 with swal for consistent alert handling
- Fix cached local SHA for accurate image inspection after docker compose pull
- Add 'Edit Stack' option to context menu
- Enhance settings and labels panel styles
- Increase font sizes in editor modal for improved readability
- Add support for Docker Hub official images in SHA retrieval
###2025.11.01 
- Docker Compose v2.40.3
###2025.05.01
- Change location of compose cli plugin.
###2025.04.30
- Docker Compose v2.35.1
###2024.09.13
- Added option to show the compose manager interface as a separate page in the header menu. (Thanks to ich777)
###2024.08.29 
- Docker Compose v2.29.2
- Fix envfile quoting in compose.sh
###2024.05.10 
- Docker Compose v2.27.0
###2024.02.20
- Fix a bug in handling of stacks without profiles.
###2024.02.19
- Add option to specify the location in which project directories are stored.
- Add basic support for handling stacks that define profiles.
###2024.01.16
- Add option to specify the path to an env file. (Thanks to mtongnz)
###2023.09.30
- Add option to recreate containers during autostart.
###2023.09.13 
- Docker Compose v2.21.0
###2023.05.24 
- Fix to patch_ui.sh for 6.12
###2023.04.27 
- Docker Compose v2.17.3
- PHP8 updates.
###2022.11.17
- Update Stack function will now remove orphaned images.
- Fix styling in Black and White themes to better match dockerman gui. (Thanks to enkows)
- Show red play icon when a container in a stack is restarting.
###2022.11.13
- Fix issue with autostart script not sanitizing stack names.
###2022.10.15
- Modify the webUI integration patches to not remove old style icons.
###2022.10.11
- Fix for the update stack function.
- Add debug option in settings.
###2022.10.05 
- Docker Compose v2.11.2
- Fix styling when unassigned devices plugin is not installed.
###2022.09.27 
- Replace compose pull function with update stack.
- Tweak the look of the stack table. 
- Add help text to settings page.
- Add label for specifying shell command.
- Add ability to patch ability to patch dockerman ui.
- Add patch to dockerman ui to fix icon caching.
- Add patch to dockerman ui to fix update ready label. 
###2022.08.02
- Docker Compose v2.9.0
- Compose Switch v1.0.5
- Fix sanitizing of project names.
###2022.07.28a
- Bugfix for improperly built SweetAlert package
###2022.07.28
- Added ability to manage unRAID webui integration labels.
- Added ability to specify alternate locations to store stack files.
- Change usage for compose.yml to the standard docker-compose.yml
###2022.05.27
- Fix package build.
###2022.05.25
- Minor bugfixes.
- Include additional ace editor files.
###2022.05.21
- Minor update to fix terminal style output in 6.10.0
- Change default compose file template to not include vesion.
###2022.05.14
- Change default output style to terminal.
- Added theme support.
- Docker Compose v2.5.0
- Compose Switch v1.0.4
###2022.05.08
- Bugfix for stack names containing spaces.
###2022.03.19 
- Added Ace editor from ace.c9.io 
- Added button for getting compose logs. Experimental mode only for now.
###2022.03.13
- Add Icons indicating stack state.
- Disable Rename and Delete buttons when stack is running.
- Add Done button to popups in experimental mode.
###2022.02.12
- Add autostart functionality.
###2022.01.26
- Add settings page.
- Add terminal style output option.
- Add Compose Pull command.
- Add handling for .env files.
###2021.12.03
- Add basic web ui
- Docker Compose v2.1.1 
- Compose Switch v1.0.3
###2021.10.03
- Initial Release 
- Docker Compose v2.0.1 
- Compose Switch v1.0.2
</CHANGES>

<!-- The 'pre-install' script. -->
<FILE Run="/bin/bash">
<INLINE>
# Remove old 'source' files
rm -f $(ls &pluginLOC;/&name;*.txz 2>/dev/null|grep -v '&packageVER;')

#Create projects folder if it doesnt exist
mkdir -p &pluginLOC;/projects

if [[ ! -f "&pluginLOC;/projects/version" ]]; then
    #Upgrade projects to latest format
    for dir in &pluginLOC;/projects/*; do
        if [[ -d $dir ]]; then
            if [[ -f $dir/compose.yml ]]; then
                mv $dir/compose.yml $dir/docker-compose.yml
            fi
        fi
    done

    echo "1" > &pluginLOC;/projects/version
fi

#Add SHOW_COMPOSE_IN_HEADER_MENU entry if not exists
grep -q "SHOW_COMPOSE_IN_HEADER_MENU=" &pluginLOC;/&name;.cfg || echo "SHOW_COMPOSE_IN_HEADER_MENU=\"false\"" &gt;&gt; &pluginLOC;/&name;.cfg

</INLINE>
</FILE>

<FILE Name="&pluginLOC;/&packagefile;" Run="upgradepkg --install-new">
<URL>&packageURL;</URL>
<MD5>&packageMD5;</MD5>
</FILE> 

<FILE Run="/bin/bash">
<INLINE>
patch_script=/usr/local/emhttp/plugins/compose.manager/scripts/patch_ui.sh
config_file=/boot/config/plugins/compose.manager/compose.manager.cfg
if [ -f "$patch_script" ]; then
    if [ -f "$config_file" ]; then
        #Grab the contents of our config file.
        source &lt;(grep = $config_file)
        patch_ui=${PATCH_UI:='false'}

        if [ $patch_ui == 'true' ]; then
            echo ""
            echo "----------------------------------------------------"
            echo " Applying WebUI Patches..."
            echo "----------------------------------------------------"
            echo ""
            #Remove patchs if already applied
            $patch_script -r

            #Apply Patches
            $patch_script
        fi
    fi
fi
</INLINE>
</FILE>

<FILE Run="/bin/bash">
<INLINE>
echo ""
echo "----------------------------------------------------"
echo " &name; has been installed."
echo " Version: &version;"
echo "----------------------------------------------------"
echo ""
</INLINE>
</FILE>

<FILE Run="/bin/bash" Method="remove">
<INLINE>
#Remove patchs if already applied
patch_remove_script=/usr/local/emhttp/plugins/compose.manager/scripts/patch_ui.sh
if [ -f "$patch_remove_script" ]; then
    $patch_remove_script -r
fi

removepkg &packageName;

# Remove plugin related files
rm -f $(ls &pluginLOC;/&name;*.txz 2>/dev/null|grep -v '&packageVER;')
</INLINE>
</FILE> 

</PLUGIN>

